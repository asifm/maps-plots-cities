---
title: 'How Similar Are US Cities to Each Other?'
subtitle: Clustering Cities Based on Socio-Economic Attributes
author: Asif Mehedi
date: '2019-03-24'
slug: 'metro-clusters'
categories: [cities, clustering, maps]
meta: yes
---

```{r setup, include=FALSE}
library(tufte)
knitr::opts_chunk$set(
  # warning = FALSE,
  # error = FALSE,
  message = FALSE,
  echo = FALSE
)

# ggplot2, tibble, tidyr,readr, purrr, dplyr, stringr, forcats
library(tidyverse)

# To get data
library(tidycensus)

# To make maps
library(tigris)
library(sf)
library(tmap)
library(leaflet)

library(animation)

options(tigris_use_cache = TRUE)
options(tigris_class = "sf")

source(here::here("helpers/loadPackages.R"))
source(here::here("helpers/getData.R"))
source(here::here("helpers/drawMaps.R"))
source(here::here("helpers/drawPlots.R"))
source(here::here("helpers/apiAcsDecennial.R"))

# https://api.census.gov/data/2017/acs/acs5/variables.html
# https://github.com/rstudio/tufte/blob/master/inst/rmarkdown/templates/tufte_html/skeleton/skeleton.Rmd
```


```{r introfigure, fig.margin = TRUE, fig.cap="Median income in metropolitan statistical areas. Source: ACS 2013–17"}


tmap::tmap_mode("view")

states_sf <- states(cb = TRUE, resolution = "20m")
medincome_msas_df <- get_acsdata_allmsas("B06011_001", geometry = TRUE)

tm_basemap(server = "CartoDB.PositronNoLabels") +
  tm_style("classic") +
  tm_shape(medincome_msas_df) +
  tm_polygons(
    col = "estimate",
    alpha = 1,
    palette = "inferno",
    popup.vars = c("NAME", "estimate"),
    title = "Median Income ($)"
  ) +
  tm_legend(position = c("right", "bottom")) +
  tm_shape(states_sf, fill = "lightblue") +
  tm_borders(col = "#000000", alpha = 0.3)

```

If we consider only socioeconomic characteristics, ignoring differences in population size, how different are small or midsize US cities, on the whole, from the larger ones? How similar are cities located in two different regions of the country, say, the cities in the southern states versus those on the west coast? Which cities are most similar to the one where you live? Is there a way to quantify the likeness or contrast between any two cities?

To answer these questions, and more, I'll apply a popular data analytic technique called _clustering_.

<!-- How clustering can be useful. Gives us a framework -->
<!-- - Should the differences be taken into account when we consider city policies? If so, how?  -->


## The Data

I'll use here a selection of data from the most recent (2013–17) version of _American Community Survey_ (ACS), the best source of socioeconomic data about US residents. My selected data comprises 382 observations, each a metropolitan statistical area,^[[About metropolitan statistical areas](https://www.census.gov/programs-surveys/metro-micro/about.html)] and about 180 variables^[See full list of variables in this [Excel file](https://www.dropbox.com/s/1d35pt8jymp770n/ACS5YR2017_ProfileVariables_Selected.xlsx?dl=0).] covering wide-ranging socioeconomic attributes of the city residents.

- Income, inequality, poverty
- Educational attainment
- Employment status, occupation
- Housing characteristics
- Immigration (both from other parts of the country and from abroad)
- Race/ethnicity, age, marital status

`r tufte::margin_note("If you look at the complete list, you may note that I've not been particularly selective. That is because *Principal Component Analysis* (PCA), soon to be performed on the data, will take care of the redundant and non-discriminant variables, doing so in a much more methodically sound way than human judgement can do at this stage.")`


Before proceeding, I'd like to note that there's nothing definitve about clustering (this will be a recurring theme throughout the analysis). The result depends not only on the choice of variables and data but also on a host of parameters that guide the computations. Yet, the exercise and the resulting clusters can be uncommonly informative, if done right.

<!-- relative numbers, not absolute -->


I'll first transform the data in a couple of ways, to improve the chances of yielding a grouping that's consistent with the clustering objective.


```{r include=FALSE}
selected_profile_variables <- read_csv(file = here::here(
    "data_/processed/ACS5YR2017_ProfileVariables_Selected.csv")) %>%
  filter(selected == 1)

# df <- get_acs(
#   geography = geo_entity_metro,
#   variables = as.vector(selected_variables$variable),
#   survey = "acs5"
# )
```


